

setwd("~/BCBSLA")

library(tidyverse)
library(sqldf)
library(dplyr)
library(readr)
library(RecordLinkage)
library(tidyr)


fl_docs <- read.csv("fl_docs.txt", sep = "\t",  quote = "\"", header = TRUE, stringsAsFactors = FALSE)
fl_ups <- read.csv("FLUPS.txt", sep = "\t",  quote = "\"", header = TRUE, 
                   stringsAsFactors = FALSE, strip.white = TRUE)
fl_usps <- read.csv("flusps.txt", sep = "\t",  quote = "\"", header = TRUE, stringsAsFactors = FALSE)

# mailing addresses
madd1a <- subset(fl_docs, grepl("box ",  PROV_PRAC_ADDR_LINE_1, ignore.case = TRUE))
madd1b <- subset(fl_docs, grepl("box ",  PROV_PRAC_ADDR_LINE_2, ignore.case = TRUE))
madd1a <- subset(madd1a, grepl("p",  PROV_PRAC_ADDR_LINE_1, ignore.case = TRUE))
madd1b <- subset(madd1b, grepl("p",  PROV_PRAC_ADDR_LINE_2, ignore.case = TRUE))



madd2a <- subset(fl_docs, grepl("box ",  PROV_MAIL_ADDR_LINE_1, ignore.case = TRUE))
madd2b <- subset(fl_docs, grepl("box ",  PROV_MAIL_ADDR_LINE_2, ignore.case = TRUE))
madd2a <- subset(madd2a, grepl("p",  PROV_MAIL_ADDR_LINE_1, ignore.case = TRUE))
madd2b <- subset(madd2b, grepl("p",  PROV_MAIL_ADDR_LINE_2, ignore.case = TRUE))


madd3a <- subset(fl_docs, grepl("box ",  PROV_BILL_ADDR_LINE_1, ignore.case = TRUE))
madd3b <- subset(fl_docs, grepl("box ",  PROV_BILL_ADDR_LINE_1, ignore.case = TRUE))
madd3a <- subset(madd3a, grepl("p",  PROV_BILL_ADDR_LINE_1, ignore.case = TRUE))
madd3b <- subset(madd3b, grepl("p",  PROV_BILL_ADDR_LINE_1, ignore.case = TRUE))


practice_address1 <- rbind(madd1a,madd1b)
mail_address1 <- rbind(madd2a,madd2b)
bill_address1 <- rbind(madd3a,madd3b)

practice_address1 <- sqldf("select distinct * from practice_address1")
mail_address1 <- sqldf("select distinct * from mail_address1")
bill_address1 <- sqldf("select distinct * from bill_address1")



fl_docs <- fl_docs %>% mutate_if(is.character, toupper(levels(fl_docs[])))
fl_ups <- fl_ups %>% mutate_if(is.character, toupper(levels(fl_ups[])))
fl_usps <- fl_usps %>% mutate_if(is.character, toupper(levels(fl_usps[])))

fl_docs2 <- sqldf("select PROV_MAIL_ADDR_LINE_1 as streetAddress, PROV_MAIL_CITY_NM as addressLocality 
                  from fl_docs")
fl_ups2 <- sqldf(" select distinct streetAddress, addressLocality from fl_ups")
fl_usps2 <- sqldf(" select distinct streetAddress, addressLocality from fl_usps")



rpairs <- compare.linkage(fl_ups2 ,fl_docs2, blockfld = FALSE ,strcmp =  c("streetAddress","addressLocality"),
                          strcmpfun = jarowinkler)
rpairs <- epiWeights(rpairs)
matched_mail <- as.data.frame(getPairs(rpairs, 1.0,0.93, single.rows=TRUE))


fl_docs2 <- sqldf("select PROV_BILL_ADDR_LINE_1 as streetAddress, 
                  PROV_BILL_CITY_NM as addressLocality from fl_docs")
rpairs <- compare.linkage(fl_ups2 ,fl_docs2, blockfld = FALSE ,strcmp =  c("streetAddress","addressLocality"),
                          strcmpfun = jarowinkler)
rpairs <- epiWeights(rpairs)
summary(rpairs)

bill_spreaD <- as.data.frame(getPairs(rpairs, 1.0,0.944, single.rows=TRUE))


fl_docs2 <- sqldf("select PROV_PRAC_ADDR_LINE_1 as streetAddress, 
                  PROV_PRAC_CITY_NM as addressLocality from fl_docs")
rpairs <- compare.linkage(fl_ups2 ,fl_docs2, blockfld = FALSE ,strcmp =  c("streetAddress","addressLocality"),
                          strcmpfun = jarowinkler)
rpairs <- epiWeights(rpairs)
summary(rpairs)

pract_spreaD <- as.data.frame(getPairs(rpairs, 1.0,0.944, single.rows=TRUE))




rpairs <- compare.linkage(fl_usps2 ,fl_docs2, blockfld =c("addressLocality") ,strcmp =  c("streetAddress"),
                          strcmpfun = jarowinkler)
rpairs <- epiWeights(rpairs)
summary(rpairs)

# practice
matched_usps <- as.data.frame(getPairs(rpairs, 1.0,0.989, single.rows=TRUE))


# make output tables


fl_docs <- data.frame(r_index = row.names(fl_docs), fl_docs)

fl_usps <- data.frame(r_index = row.names(fl_usps), fl_usps)

matched_usps2 <- sqldf("select m.*, f.* from matched_usps m, fl_docs f
                       where f.r_index = m.id2")

names(matched_usps2)[2] <- "USPS_Address"
names(matched_usps2)[3] <- "USPS_City"
names(matched_usps2)[7] <- "Score"
matched_usps2$streetAddress.2 <- NULL
matched_usps2$addressLocality.2 <- NULL
matched_usps2$id2 <- NULL
matched_usps2$id1 <- NULL
matched_usps2$r_index <- NULL



matched_mail2 <- sqldf("select m.*, f.* from matched_mail m, fl_docs f
                       where f.r_index = m.id2")
names(matched_mail2)[2] <- "UPS_Address"
names(matched_mail2)[3] <- "UPS_City"
names(matched_mail2)[7] <- "Score"
matched_mail2$streetAddress.2 <- NULL
matched_mail2$addressLocality.2 <- NULL
matched_mail2$id2 <- NULL
matched_mail2$id1 <- NULL
matched_mail2$r_index <- NULL

bill_spreaD2<- sqldf("select m.*, f.* from bill_spreaD m, fl_docs f
                       where f.r_index = m.id2")

names(bill_spreaD2)[2] <- "UPS_Address"
names(bill_spreaD2)[3] <- "UPS_City"
names(bill_spreaD2)[7] <- "Score"
bill_spreaD2$streetAddress.2 <- NULL
bill_spreaD2$addressLocality.2 <- NULL
bill_spreaD2$id2 <- NULL
bill_spreaD2$id1 <- NULL
bill_spreaD2$r_index <- NULL


pract_spreaD2<- sqldf("select m.*, f.* from pract_spreaD m, fl_docs f
                       where f.r_index = m.id2")

names(pract_spreaD2)[2] <- "UPS_Address"
names(pract_spreaD2)[3] <- "UPS_City"
names(pract_spreaD2)[7] <- "Score"
pract_spreaD2$streetAddress.2 <- NULL
pract_spreaD2$addressLocality.2 <- NULL
pract_spreaD2$id2 <- NULL
pract_spreaD2$id1 <- NULL
pract_spreaD2$r_index <- NULL

 write.table(matched_mail2, file = "matched_mail2.csv",
            row.names = FALSE, sep ="\t")

 write.table(bill_spreaD2, file = "bill_spreaD2.csv",
             row.names = FALSE, sep ="\t")

 write.table(pract_spreaD2, file = "pract_spreaD2.csv",
             row.names = FALSE, sep ="\t")

 
 write.table(matched_usps2, file = "matched_usps.csv",
             row.names = FALSE, sep ="\t")


